name: RDP

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: windows-latest
    timeout-minutes: 1440  # 24 hours max is safer than 60 hours

    env:
      TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Configure RDP & Open Firewall (Tailscale only)
        run: |
          # Enable RDP
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          # Disable NLA (required for many RDP clients when connecting over Tailscale)
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force

          # Remove old rule if exists
          netsh advfirewall firewall delete rule name="RDP-Tailscale" | Out-Null

          # Allow RDP only from Tailscale subnet (100.64.0.0/10) – much safer
          netsh advfirewall firewall add rule name="RDP-Tailscale" dir=in action=allow protocol=TCP localport=3389 remoteip=100.64.0.0/10

          # Restart service
          Restart-Service TermService -Force

      - name: Create RDP Admin User + Strong Random Password
        run: |
          $PasswordLength = 20
          $Password = -join ((33..126) | Get-Random -Count $PasswordLength | % {[char]$_})
          $SecurePass = ConvertTo-SecureString $Password -AsPlainText -Force

          New-LocalUser -Name "rdpadmin" -Password $SecurePass -FullName "RDP Admin" -Description "Temporary GitHub Actions RDP user" -AccountNeverExpires:$true -PasswordNeverExpires:$true
          Add-LocalGroupMember -Group "Administrators" -Member "rdpadmin"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "rdpadmin"

          # Save credentials for later steps and final output
          Write-Output "RDP_USER=rdpadmin" >> $env:GITHUB_ENV
          Write-Output "RDP_PASSWORD=$Password" >> $env:GITHUB_ENV
          # Also set as masked secret output
          Write-Output "RDP_PASSWORD=$Password" >> $env:GITHUB_OUTPUT

      - name: Install Latest Tailscale
        run: |
          # Official PowerShell one-liner from Tailscale (always up-to-date)
          PowerShell -Command "Invoke-WebRequest -Uri https://pkgs.tailscale.com/stable/tailscale_setup_latest_x64.msi -OutFile $env:TEMP\tailscale.msi"
          Start-Process msiexec.exe -Wait -ArgumentList '/i', "$env:TEMP\tailscale.msi", '/quiet', '/norestart'
          Remove-Item "$env:TEMP\tailscale.msi" -Force

      - name: Start Tailscale
        run: |
          $authKey = "$env:TAILSCALE_AUTH_KEY"
          if (-not $authKey) { Write-Error "TAILSCALE_AUTH_KEY secret is missing"; exit 1 }

          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$authKey --hostname="gha-rdp-$env:GITHUB_RUN_ID" --accept-risk=all

          # Wait for IP
          $ip = $null
          for ($i=0; $i -lt 20; $i++) {
            $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip --4 | Select-Object -First 1
            if ($ip) { break }
            Start-Sleep -Seconds 6
          }
          if (-not $ip) { Write-Error "Failed to get Tailscale IP"; exit 1 }

          Write-Output "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV

      - name: Verify RDP Port is Reachable over Tailscale
        run: |
          $result = Test-NetConnection -ComputerName $env:TAILSCALE_IP -Port 3389 -WarningAction SilentlyContinue
          if (-not $result.TcpTestSucceeded) {
            Write-Error "RDP port 3389 is not reachable over Tailscale!"
            exit 1
          }
          Write-Host "RDP port test succeeded!"

      - name: Display Connection Details
        run: |
          Write-Host "========================================"
          Write-Host "RDP CONNECTION READY"
          Write-Host "Tailscale IP  : $($env:TAILSCALE_IP)"
          Write-Host "Username      : $($env:RDP_USER)"
          Write-Host "Password      : $($env:RDP_PASSWORD)"
          Write-Host "========================================"
          Write-Host "Connect using any RDP client to $($env:TAILSCALE_IP)"
          Write-Host "Session will stay alive until you cancel the workflow."

      - name: Keep Runner Alive
        if: success()
        run: |
          # Infinite loop – GitHub will kill after ~24h anyway
          while ($true) {
            Write-Host "[$(Get-Date -Format 'HH:mm:ss')] RDP session active – Cancel workflow to terminate"
            Start-Sleep -Seconds 300
          }
